<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Fan Curves via XML Upload & Edition</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        img {
            max-width: 400px;
            margin: 10px 0;
        }

        .fan-label {
            font-weight: bold;
            margin-top: 20px;
        }

        fieldset {
            margin-bottom: 15px;
        }

        .dl-btn {
            margin: 10px 5px 10px 0;
            padding: 6px 12px;
            font-size: 1em;
        }

        #main-btn {
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h2 id="maintitle"></h2>
    <input type="file" id="xmlFile" accept=".xml">
    <span id="uploadlabel"></span>
    <div id="fanForm"></div>
    <button id="main-btn" onclick="processFans()"></button>
    <pre id="result"></pre>
    <div id="fanArea1"></div>
    <div id="fanArea2"></div>

    <script>
        // --- TRANSLATION DICTIONARY AND LANGUAGE DETECTION ---
        const i18n = {
            en: {
                title: "Fan Curves via XML Upload & Edition",
                upload: "Select XML file",
                loaded: "File loaded. Edit values and calculate curves:",
                compute: "Calculate Curves",
                model: "Model",
                cfm: "CFM",
                sp: "SP",
                temp: "Temperature",
                altitude: "Altitude",
                download: "Download JPG",
                calculating: "Calculating...",
                done: "Curves calculated.",
                notfound: "No JPG curve found or SOAP error.",
                backend: "Backend error: ",
                ready: "Choose a file to begin."
            },
            fr: {
                title: "Courbes ventilateur: import XML et édition",
                upload: "Importer un fichier XML",
                loaded: "Fichier chargé et formulaire prêt :",
                compute: "Calculer les Courbes",
                model: "Modèle",
                cfm: "CFM",
                sp: "SP",
                temp: "Température",
                altitude: "Altitude",
                download: "Télécharger JPG",
                calculating: "Calcul en cours...",
                done: "Courbes calculées.",
                notfound: "Pas de courbe JPG trouvée ou erreur SOAP.",
                backend: "Erreur backend : ",
                ready: "Choisissez un fichier pour commencer."
            }
        };
        // Can add more languages: "es", "de"...

        const userLang = navigator.language && navigator.language.startsWith("fr")
            ? "fr"
            : "en";
        // END TRANSLATION SETUP

        // Set initial UI text
        document.title = i18n[userLang].title;
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('maintitle').textContent = i18n[userLang].title;
            document.getElementById('main-btn').textContent = i18n[userLang].compute;
            document.getElementById('uploadlabel').textContent = i18n[userLang].upload;
            document.getElementById('result').textContent = i18n[userLang].ready;
        });

        // --- APP LOGIC ---
        let fans = [];
        let base64Imgs = [];

        function displayFormFromXML(xmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlContent, "text/xml");
            const elevation = doc.querySelector("Elevation")?.textContent || "0";

            const airFrais = doc.querySelector("Ventilateurs > AirFrais");
            const fanFrais = {
                label: "AirFrais",
                model: airFrais?.querySelector("Model")?.textContent || "",
                cfm: airFrais?.querySelector("CFM")?.textContent || "",
                sp: airFrais?.querySelector("SP")?.textContent || "",
                temp: airFrais?.querySelector("Temp")?.textContent || "",
                altitude: elevation
            };

            const airVicie = doc.querySelector("Ventilateurs > AirVicie");
            const fanVicie = {
                label: "AirVicie",
                model: airVicie?.querySelector("Model")?.textContent || "",
                cfm: airVicie?.querySelector("CFM")?.textContent || "",
                sp: airVicie?.querySelector("SP")?.textContent || "",
                temp: airVicie?.querySelector("Temp")?.textContent || "",
                altitude: elevation
            };

            fans = [fanFrais, fanVicie];

            // Generate the editable form
            let formHTML = '';
            fans.forEach((fan, idx) => {
                formHTML += `<fieldset>
      <legend>${fan.label}</legend>
      ${i18n[userLang].model}: <input id="model${idx}" value="${fan.model}"><br>
      ${i18n[userLang].cfm}: <input id="cfm${idx}" value="${fan.cfm}"><br>
      ${i18n[userLang].sp}: <input id="sp${idx}" value="${fan.sp}"><br>
      ${i18n[userLang].temp}: <input id="temp${idx}" value="${fan.temp}"><br>
      ${i18n[userLang].altitude}: <input id="altitude${idx}" value="${fan.altitude}"><br>
    </fieldset>`;
            });
            document.getElementById('fanForm').innerHTML = formHTML;
            document.getElementById('result').textContent = i18n[userLang].loaded;
            document.getElementById('fanArea1').innerHTML = '';
            document.getElementById('fanArea2').innerHTML = '';
        }

        document.getElementById('xmlFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                displayFormFromXML(evt.target.result);
            };
            reader.readAsText(file);
        });

        async function processFans() {
            base64Imgs.length = 0;
            document.getElementById('result').textContent = i18n[userLang].calculating;
            for (let i = 0; i < fans.length; i++) {
                const model = document.getElementById(`model${i}`).value;
                const cfm = document.getElementById(`cfm${i}`).value;
                const sp = document.getElementById(`sp${i}`).value;
                const temp = document.getElementById(`temp${i}`).value;
                const altitude = document.getElementById(`altitude${i}`).value;
                let soapBody = `
      <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
        <soap:Body>
          <CalcFanWithJPGCurves xmlns="http://tempuri.org/">
            <strModel>${model}</strModel>
            <sSP>${sp}</sSP>
            <sCFM>${cfm}</sCFM>
            <sTemperature>${temp}</sTemperature>
            <sAltitude>${altitude}</sAltitude>
          </CalcFanWithJPGCurves>
        </soap:Body>
      </soap:Envelope>`;

                try {
                    const response = await fetch("/soapproxy", {
                        method: "POST",
                        headers: { "Content-Type": "text/xml; charset=utf-8" },
                        body: soapBody
                    });
                    const xmlSoap = await response.text();
                    const match = xmlSoap.match(/<FanCurveLargeJPG>([\s\S]*?)<\/FanCurveLargeJPG>/);
                    if (match && match[1].length > 10) {
                        const cleanBase64 = match[1].replace(/\s/g, '');
                        base64Imgs[i] = cleanBase64;
                        document.getElementById(`fanArea${i + 1}`).innerHTML =
                            `<div class="fan-label">${fans[i].label}</div>
           <img src="data:image/jpeg;base64,${cleanBase64}" alt="Fan Curve">
           <br>
           <button class="dl-btn" onclick="downloadImg(${i})">${i18n[userLang].download}</button>`;
                    } else {
                        document.getElementById(`fanArea${i + 1}`).innerHTML =
                            `<div class="fan-label">${fans[i].label}</div>
           ${i18n[userLang].notfound}`;
                        base64Imgs[i] = null;
                    }
                } catch (err) {
                    document.getElementById(`fanArea${i + 1}`).innerHTML =
                        `<div class="fan-label">${fans[i].label}</div>
         ${i18n[userLang].backend}${err.message}`;
                    base64Imgs[i] = null;
                }
            }
            document.getElementById('result').textContent = i18n[userLang].done;
        }

        function downloadImg(idx) {
            if (!base64Imgs[idx]) return;
            const link = document.createElement('a');
            link.href = 'data:image/jpeg;base64,' + base64Imgs[idx];
            link.download = `FanCurve_${idx + 1}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>